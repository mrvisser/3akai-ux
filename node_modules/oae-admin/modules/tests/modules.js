/*!
 * Copyright 2014 Apereo Foundation (AF) Licensed under the
 * Educational Community License, Version 2.0 (the "License"); you may
 * not use this file except in compliance with the License. You may
 * obtain a copy of the License at
 *
 *     http://opensource.org/licenses/ECL-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an "AS IS"
 * BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express
 * or implied. See the License for the specific language governing
 * permissions and limitations under the License.
 */

casper.test.begin('Widget - Modules', function(test) {

    /**
     * Verify that tenant module settings can be changed
     */
    var verifyTenantModuleSettingsChange = function() {
        // Double check that the form is present
        test.assertExists('#modules-container .admin-table-striped-toggle[title="Edit the OAE Tenant Module"] + div form.modules-configuration-form', 'The form is present for the Tenant module');
        // Change a setting
        casper.fill('form[data-module="oae-tenants"]', {
            'oae-tenants/actions/allowStop': false,
            'oae-tenants/tenantprivacy/tenantprivate': false
        });
        // Submit the form
        casper.click('#modules-container .admin-table-striped-toggle[title="Edit the OAE Tenant Module"] + div form.modules-configuration-form button[type="submit"]');
        // Change it back
        casper.fill('form[data-module="oae-tenants"]', {
            'oae-tenants/actions/allowStop': true,
            'oae-tenants/tenantprivacy/tenantprivate': false
        });
        // Submit the form
        casper.click('#modules-container .admin-table-striped-toggle[title="Edit the OAE Tenant Module"] + div form.modules-configuration-form button[type="submit"]');
        // Wait for a notification to show and verify it's not an error
        casper.waitForSelector('#oae-notification-container .alert', function() {
            test.assertDoesntExist('#oae-notification-container .alert.alert-error', 'Configuration successfully saved');
        });
    };

    /**
     * Verify that all elements for changing tenant settings are present
     */
    var verifyTenantModuleSettingsPresent = function() {
        casper.waitForSelector('#tenants-container .table', function() {
            // Verify that global admin can go into tenant administration
            test.assertExists('#tenants-container .table a[href="/tenant/test"]', 'The test tenant configuration link is present in the global administration panel');
            // Verify that following the edit link brings us to tenant administration
            casper.click('#tenants-container .table a[href="/tenant/test"]');
            casper.waitForSelector('#adminheader-content h1', function() {
                test.assertSelectorHasText('#adminheader-content h1', 'CasperJS Tenant', 'The test tenant configuration can be accessed through the global administration panel');
                // Verify that the left hand navigation has options for tenant, modules and skinning
                test.assertExists('.oae-lhnavigation ul.nav li a[href="/tenant/' + configUtil().tenantAlias + '/tenants"]', 'The \'Tenants\' left hand nav link is present');
                test.assertExists('.oae-lhnavigation ul.nav li a[href="/tenant/' + configUtil().tenantAlias + '/modules"]', 'The \'Modules\' left hand nav link is present');
                test.assertExists('.oae-lhnavigation ul.nav li a[href="/tenant/' + configUtil().tenantAlias + '/skinning"]', 'The \'Skinning\' left hand nav link is present');
                // Verify that there are module toggle buttons on the page
                casper.click('.oae-lhnavigation ul.nav li a[href="/tenant/' + configUtil().tenantAlias + '/modules"]');
                casper.waitForSelector('#modules-container .admin-table-striped', function() {
                    test.assertExists('#modules-container .admin-table-striped-toggle', 'Module configuration toggle buttons are present');
                    // Open the module containers
                    casper.click('#modules-container .admin-table-striped-toggle[title="Edit the OAE Tenant Module"]');
                    casper.click('#modules-container .admin-table-striped-toggle[title="Edit the OAE Authentication Module"]');
                    casper.click('#modules-container .admin-table-striped-toggle[title="Edit the OAE Email Module"]');
                    casper.click('#modules-container .admin-table-striped-toggle[title="Edit the OAE Discussions Module"]');
                    casper.click('#modules-container .admin-table-striped-toggle[title="Edit the OAE Activity Module"]');
                    casper.click('#modules-container .admin-table-striped-toggle[title="Edit the OAE Content Module"]');
                    casper.click('#modules-container .admin-table-striped-toggle[title="Edit the OAE Preview Processor Module"]');
                    casper.click('#modules-container .admin-table-striped-toggle[title="Edit the OAE Principals Module"]');
                    // Verify that each module has a form
                    test.assertExists('#modules-container .admin-table-striped-toggle[title="Edit the OAE Tenant Module"] + div form.modules-configuration-form', 'The form is present for the Tenant module');
                    test.assertExists('#modules-container .admin-table-striped-toggle[title="Edit the OAE Authentication Module"] + div form.modules-configuration-form', 'The form is present for the Authentication module');
                    test.assertExists('#modules-container .admin-table-striped-toggle[title="Edit the OAE Email Module"] + div form.modules-configuration-form', 'The form is present for the Email module');
                    test.assertExists('#modules-container .admin-table-striped-toggle[title="Edit the OAE Discussions Module"] + div form.modules-configuration-form', 'The form is present for the Discussions module');
                    test.assertExists('#modules-container .admin-table-striped-toggle[title="Edit the OAE Activity Module"] + div form.modules-configuration-form', 'The form is present for the Activity module');
                    test.assertExists('#modules-container .admin-table-striped-toggle[title="Edit the OAE Content Module"] + div form.modules-configuration-form', 'The form is present for the Content module');
                    test.assertExists('#modules-container .admin-table-striped-toggle[title="Edit the OAE Preview Processor Module"] + div form.modules-configuration-form', 'The form is present for the Preview Processor Module module');
                    test.assertExists('#modules-container .admin-table-striped-toggle[title="Edit the OAE Principals Module"] + div form.modules-configuration-form', 'The form is present for the Principals module');
                    // Verify that each module has a 'Save' button
                    test.assertExists('#modules-container .admin-table-striped-toggle[title="Edit the OAE Tenant Module"] + div form.modules-configuration-form button[type="submit"]', 'The submit button is present for the Tenant module');
                    test.assertExists('#modules-container .admin-table-striped-toggle[title="Edit the OAE Authentication Module"] + div form.modules-configuration-form button[type="submit"]', 'The submit button is present for the Authentication module');
                    test.assertExists('#modules-container .admin-table-striped-toggle[title="Edit the OAE Email Module"] + div form.modules-configuration-form button[type="submit"]', 'The submit button is present for the Email module');
                    test.assertExists('#modules-container .admin-table-striped-toggle[title="Edit the OAE Discussions Module"] + div form.modules-configuration-form button[type="submit"]', 'The submit button is present for the Discussions module');
                    test.assertExists('#modules-container .admin-table-striped-toggle[title="Edit the OAE Activity Module"] + div form.modules-configuration-form button[type="submit"]', 'The submit button is present for the Activity module');
                    test.assertExists('#modules-container .admin-table-striped-toggle[title="Edit the OAE Content Module"] + div form.modules-configuration-form button[type="submit"]', 'The submit button is present for the Content module');
                    test.assertExists('#modules-container .admin-table-striped-toggle[title="Edit the OAE Preview Processor Module"] + div form.modules-configuration-form button[type="submit"]', 'The submit button is present for the Preview Processor Module module');
                    test.assertExists('#modules-container .admin-table-striped-toggle[title="Edit the OAE Principals Module"] + div form.modules-configuration-form button[type="submit"]', 'The submit button is present for the Principals module');
                });
            });
        });
    };

    casper.start(configUtil().adminUI, function() {
        // Log in with admin user
        casper.then(function() {
            userUtil().doAdminLogIn(configUtil().adminUsername, configUtil().adminPassword);
        });

        // Verify tenant module settings
        casper.then(function() {
            casper.echo('Verify the tenant module settings present', 'INFO');
            verifyTenantModuleSettingsPresent();
        });

        // Verify tenant module settings can be changed
        casper.then(function() {
            casper.echo('Verify the tenant module settings can be changed', 'INFO');
            verifyTenantModuleSettingsChange();
        });

        // Log out with admin user
        casper.then(function() {
            userUtil().doAdminLogOut();
        });
    });

    casper.run(function() {
        test.done();
    });
});
